<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with CV Assistant</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/styles.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
</head>
<body>
    <div id="chatbox" class="container">
        <header class="text-center">
            <h1>Chat with CV Assistant</h1>
            <h2 class="text-muted">Your expert on Román Flores Rodríguez's CV</h2>
        </header>
        <main id="messages" class="mb-3 p-3 border rounded"></main>
        <footer class="input-group">
            <input type="text" id="message" class="form-control" placeholder="Type your message here...">
            <div class="input-group-append">
                <button id="send" class="btn btn-primary">Send</button>
            </div>
            <div class="input-group-append">
                <a href="/static/cv/cv.pdf" class="btn btn-secondary" id="download-cv" download>Download CV</a>
            </div>
        </footer>
    </div>

    <script>
        $(document).ready(() => {
            const md = window.markdownit();

            const appendMessage = (message, type) => {
                const imgSrc = type === 'user' ? '/static/images/user.png' : '/static/images/bot.png';
                const sender = type === 'user' ? 'You' : 'CV Assistant';
                const messageHtml = `
                    <div class="message ${type}">
                        <img src="${imgSrc}" alt="${sender}">
                        <div><strong>${sender}:</strong> ${message}</div>
                    </div>
                `;
                $('#messages').append(messageHtml);
                $('#messages').scrollTop($('#messages')[0].scrollHeight);
            };

            const showLoading = () => {
                const loadingHtml = `
                    <div class="message ai loading">
                        <img src="/static/images/bot.png" alt="CV Assistant">
                        <div><strong>CV Assistant:</strong> <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Typing...</div>
                    </div>
                `;
                $('#messages').append(loadingHtml);
                $('#messages').scrollTop($('#messages')[0].scrollHeight);
            };

            const hideLoading = () => {
                $('.message.loading').remove();
            };

            $('#send').click(() => {
                const message = $('#message').val().trim();
                if (message) {
                    appendMessage(message, 'user');
                    showLoading();
                    $.ajax({
                        url: '/chat',
                        method: 'POST',
                        data: { message },
                        success: (response) => {
                            hideLoading();
                            const renderedMessage = md.render(response.response);
                            appendMessage(renderedMessage, 'ai');
                            $('#message').val('');
                        }
                    });
                }
            });

            $('#message').keypress((e) => {
                if (e.which === 13) {
                    $('#send').click();
                }
            });
        });
    </script>
</body>
</html>